---
import { Icon } from 'astro-icon/components';
import { SITE } from 'astrowind:config';
import { getHomePermalink } from '~/utils/permalinks';

interface SocialLink {
  ariaLabel: string;
  icon: string;
  href?: string;      // if exists: click jumps
  label?: string;     // text shown in popover
  copyText?: string;  // copy button
  qrSrc?: string;     // qr image url (public/)
}

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
}

export interface Props {
  secondaryLinks?: Array<Link>;     // use for Support/About
  socialLinks?: Array<SocialLink>;  // your 3 icons
  footNote?: string;
  theme?: string;
}

const {
  socialLinks = [],
  secondaryLinks = [],
  footNote = '',
  theme = 'light',
} = Astro.props;
---

<footer class:list={[{ dark: theme === 'dark' }, 'relative border-t border-gray-200 dark:border-slate-800 not-prose']}>
  <div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden="true"></div>

  <div class="relative max-w-7xl mx-auto px-4 sm:px-6 dark:text-slate-300">
    <!-- ONE ROW: brand | middle links | icons right -->
    <div class="py-6 md:py-8">
      <div class="flex items-center justify-between gap-4">
        <!-- Left: Brand -->
        <a class="flex items-center font-bold text-lg" href={getHomePermalink()}>
          {SITE?.name ?? 'QYep'}
        </a>

        <!-- Middle: Support / About -->
        <div class="flex items-center gap-10">
          {secondaryLinks.map((l) => (
            <a
              class="text-muted hover:underline"
              href={l.href ?? '#'}
              aria-label={l.ariaLabel}
              set:html={l.text ?? ''}
            />
          ))}
        </div>

        <!-- Right: 3 icons -->
        <div class="flex items-center gap-2">
          {socialLinks.map((item) => (
            <div class="relative group">
              {item.href ? (
                <a
                  class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-white/30 bg-white/40 backdrop-blur-xl
                         hover:bg-white/60 dark:border-white/10 dark:bg-slate-900/40 dark:hover:bg-slate-900/60"
                  aria-label={item.ariaLabel}
                  href={item.href}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <Icon name={item.icon} class="h-5 w-5" />
                </a>
              ) : (
                <button
                  type="button"
                  class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-white/30 bg-white/40 backdrop-blur-xl
                         hover:bg-white/60 dark:border-white/10 dark:bg-slate-900/40 dark:hover:bg-slate-900/60"
                  aria-label={item.ariaLabel}
                >
                  <Icon name={item.icon} class="h-5 w-5" />
                </button>
              )}

              {/* Popover (no hover gap) */}
              <div
                class="absolute right-0 bottom-full -mb-px z-50 w-72 rounded-2xl border border-white/30 bg-white/70 p-4 shadow-lg backdrop-blur-xl
                       invisible opacity-0 translate-y-2 transition
                       pointer-events-none
                       group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto
                       group-focus-within:visible group-focus-within:opacity-100 group-focus-within:translate-y-0 group-focus-within:pointer-events-auto
                       dark:border-white/10 dark:bg-slate-900/70"
              >
                <div class="text-sm font-semibold">{item.ariaLabel}</div>

                {item.label && <div class="mt-2 text-sm opacity-80 break-all">{item.label}</div>}

                {item.qrSrc && (
                  <img
                    src={item.qrSrc}
                    alt="QQ QR code"
                    class="mt-3 w-40 rounded-xl border border-white/30 dark:border-white/10"
                  />
                )}

                <div class="mt-3 flex flex-wrap gap-2">
                  {item.copyText && (
                    <button
                      type="button"
                      class="rounded-lg border border-white/30 bg-white/40 px-3 py-1 text-sm hover:bg-white/60
                             dark:border-white/10 dark:bg-slate-900/40 dark:hover:bg-slate-900/60"
                      data-copy={item.copyText}
                    >
                      Copy
                    </button>
                  )}

                  {item.href && (
                    <a
                      class="rounded-lg border border-white/30 bg-white/40 px-3 py-1 text-sm hover:bg-white/60
                             dark:border-white/10 dark:bg-slate-900/40 dark:hover:bg-slate-900/60"
                      href={item.href}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Open
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- footnote (bottom spacing) -->
      <div class="text-sm dark:text-muted mt-6 pb-10">
        <Fragment set:html={footNote} />
      </div>
    </div>
  </div>
</footer>

<script is:inline>
  document.addEventListener('click', async (e) => {
    const btn = e.target?.closest?.('[data-copy]');
    if (!btn) return;

    const text = btn.getAttribute('data-copy');
    if (!text) return;

    try {
      await navigator.clipboard.writeText(text);
      const old = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(() => (btn.textContent = old), 900);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      const old = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(() => (btn.textContent = old), 900);
    }
  });
</script>
